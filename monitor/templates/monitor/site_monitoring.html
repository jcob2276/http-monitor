<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>Dashboard Monitoringu HTTP</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
            padding: 2rem;
        }
        .table th, .table td {
            vertical-align: middle;
            text-align: center;
        }
        .status-up {
            color: green;
            font-weight: bold;
        }
        .status-down {
            color: red;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">

        <h1 class="mb-4 text-center">ðŸ“¡ Monitoring stron</h1>

        {% if active_alerts %}
            <div class="alert alert-danger">
                <h5><strong>ðŸš¨ Aktywne alerty:</strong></h5>
                <ul class="mb-0">
                    {% for alert in active_alerts %}
                    <li>
                        <strong>{{ alert.website.name }}</strong> â€“ {{ alert.message }}
                        (od {{ alert.created_at|timesince }} temu)
                    </li>
                    {% endfor %}
                </ul>
            </div>
        {% endif %}

        <form method="get" class="mb-4">
            <label for="website_id" class="form-label">Wybierz stronÄ™:</label>
            <select name="website_id" id="website_id" class="form-select" onchange="this.form.submit()">
                <option value="">-- wybierz --</option>
                {% for site in websites %}
                    <option value="{{ site.id }}" {% if selected_website and site.id == selected_website.id %}selected{% endif %}>
                        {{ site.name }}
                    </option>
                {% endfor %}
            </select>
        </form>

        {% if selected_website %}
            <h2 class="mt-4">ðŸ“‹ Pomiar dla: {{ selected_website.url }}</h2>

            <div class="alert alert-info mt-3">
                <strong>KPI (ostatnie 24h):</strong><br>
                Åšredni czas odpowiedzi: <strong>{{ avg_response }}s</strong><br>
                Liczba pomiarÃ³w: <strong>{{ total_checks }}</strong><br>
                Uptime: <strong>{{ uptime_percent }}%</strong>
            </div>

            <a href="{% url 'generate_report' %}" class="btn btn-primary mb-3">
    ðŸ“„ Pobierz raport PDF
</a>


            <table class="table table-bordered table-striped">
                <thead class="table-dark">
                    <tr>
                        <th>Status</th>
                        <th>Czas odpowiedzi (s)</th>
                        <th>Data</th>
                    </tr>
                </thead>
                <tbody>
                    {% for result in results %}
                    <tr>
                        <td>{{ result.status_code }}</td>
                        <td>{{ result.response_time|floatformat:2 }}</td>
                        <td>{{ result.timestamp }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>

            <h3 class="mt-5">ðŸ“Š Wykres odpowiedzi</h3>
            <canvas id="responseChart" width="100%" height="40"></canvas>
        {% else %}
            <p class="text-muted">Wybierz stronÄ™, aby zobaczyÄ‡ dane.</p>
        {% endif %}
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const ctx = document.getElementById('responseChart')?.getContext('2d');
        let responseChart;

        async function loadChartData() {
            const urlParams = new URLSearchParams(window.location.search);
            const websiteId = urlParams.get('website_id');

            if (!websiteId || !ctx) return;

            const res = await fetch(`/api/chart-data/?website_id=${websiteId}`);
            const data = await res.json();

            if (responseChart) responseChart.destroy();

            responseChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: data.label,
                        data: data.response_times,
                        borderColor: 'rgba(75, 192, 192, 1)',
                        tension: 0.3,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: true, position: 'bottom' },
                        title: { display: true, text: 'Czas odpowiedzi' }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 's' }
                        }
                    }
                }
            });
        }

        loadChartData();
    </script>
</body>
</html>
